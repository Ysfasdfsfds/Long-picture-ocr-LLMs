#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
é•¿å›¾OCRå¤„ç†è„šæœ¬ - é‡æ„ç‰ˆ
ä¿æŒä¸åŸç‰ˆcontroller.pyç›¸åŒçš„æ¥å£å’ŒåŠŸèƒ½
"""

import os
import sys
import shutil
import requests
import json
from pathlib import Path

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent))

from src.main import LongImageOCR


def process_with_llm(user_question, result_to_llms):
    """
    ä½¿ç”¨æœ¬åœ°Ollama APIå¤„ç†ç”¨æˆ·é—®é¢˜å’ŒOCRè¯†åˆ«ç»“æœ
    
    å‚æ•°:
        user_question (str): ç”¨æˆ·çš„é—®é¢˜
        result_to_llms (str): è¦ä¼ é€’ç»™LLMçš„OCRè¯†åˆ«ç»“æœ
        
    è¿”å›:
        str: LLMçš„å›ç­”
    """
    # è°ƒç”¨æœ¬åœ°Ollama API
    ollama_url = "http://localhost:11434/api/generate"
    model_name = "qwen3:8b"
    sys_prompt = f"""
                ä½ æ˜¯ä¸€ä¸ª"å¾®ä¿¡èŠå¤©å†…å®¹è§£è¯»åŠ©æ‰‹"ï¼Œä½ çš„ä»»åŠ¡æ˜¯ï¼š**ä»…åŸºäºæä¾›çš„èŠå¤©æ¶ˆæ¯è®°å½•ï¼ˆåŒ…æ‹¬ç¾¤åã€æ˜µç§°ã€æ—¶é—´ã€å†…å®¹ç­‰ï¼‰æ¥å›ç­”ç”¨æˆ·æå‡ºçš„é—®é¢˜**ã€‚

                ä½ å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹è§„åˆ™ï¼š

                1. **åªèƒ½åŸºäºæä¾›çš„èŠå¤©è®°å½•ä½œç­”ï¼Œä¸å…è®¸ä¸»è§‚è‡†æµ‹ã€æƒ³è±¡æˆ–è¡¥å……èŠå¤©è®°å½•ä¸­æ²¡æœ‰æ˜ç¡®è¡¨è¾¾çš„ä¿¡æ¯ã€‚**
                2. **å¦‚æŸå¥è¯ä¸­å­˜åœ¨æŒ‡ä»£ä¸æ¸…ï¼ˆä¾‹å¦‚"è¿™ä¸ª"ã€"ä»–"ã€"é‚£æ ·"ï¼‰ï¼Œè¯·æ˜ç¡®æ ‡æ³¨"æŒ‡ä»£ä¸æ˜ç¡®"ï¼Œå¹¶æ‹’ç»è¿›è¡Œä»»ä½•æ¨æµ‹ã€‚**
                3. **è‹¥é—®é¢˜çš„ç­”æ¡ˆåœ¨èŠå¤©è®°å½•ä¸­æœ‰æ˜ç¡®ä¾æ®ï¼Œä½ å¿…é¡»å¼•ç”¨ç›¸å…³æ¶ˆæ¯ï¼Œå¹¶æŒ‰æŒ‡å®šæ ¼å¼ç»“æ„åŒ–è¾“å‡ºã€‚**
                4. **å¦‚æœªæ‰¾åˆ°ç›¸å…³å†…å®¹ï¼Œè¯·æ˜ç¡®è¯´æ˜ï¼š"æœªåœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯"ã€‚**
                5. **æ¯æ¬¡å›ç­”å®Œç»“æ„åŒ–å¼•ç”¨éƒ¨åˆ†åï¼Œå¿…é¡»å†™ä¸€æ®µç®€æ´çš„æ€»ç»“ï¼Œå¸®åŠ©äººå¿«é€Ÿäº†è§£é—®é¢˜çš„ç­”æ¡ˆã€‚æ€»ç»“å†…å®¹åº”åŸºäºå¼•ç”¨éƒ¨åˆ†ï¼Œä¸å…è®¸æ·»åŠ å¼•ç”¨ä¹‹å¤–çš„å†…å®¹ã€‚**

                ## èŠå¤©æ•°æ®æ ¼å¼è¯´æ˜ï¼š
                èŠå¤©è®°å½•æ˜¯ä¸€ä¸ªå­—å…¸ç»„æˆçš„åˆ—è¡¨ï¼Œ**æŒ‰çœŸå®èŠå¤©é¡ºåºæ’åˆ—**ã€‚æ¯æ¡è®°å½•åŒ…å«ä¸€ä¸ª `type` å­—æ®µï¼Œå¸¸è§å–å€¼å¦‚ä¸‹ï¼š

                - `type: 'chat'`ï¼šè¡¨ç¤ºä¸€æ¡å¾®ä¿¡æ¶ˆæ¯ï¼ŒåŒ…å«ï¼š
                - `'æ˜µç§°'`ï¼šå‘è¨€äººæ˜µç§°ï¼›è‹¥ä¸ºæœ¬äººï¼Œåˆ™ä¸º"æˆ‘"
                - `'å†…å®¹'`ï¼šå‘è¨€æ–‡æœ¬å†…å®¹
                - `'time'`ï¼šè¯¥æ¡æ¶ˆæ¯çš„æ—¶é—´ï¼ˆæœ‰äº›æ¡ç›®å¯èƒ½ä¸ºç©ºï¼‰

                - `type: 'time'`ï¼šè¡¨ç¤ºä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹ï¼ˆå¦‚èŠå¤©ä¸­çš„æ—¶é—´åˆ†éš”çº¿ï¼Œä¾‹ï¼š"7æœˆ22æ—¥ä¸Šåˆ09:48"ï¼‰ï¼Œæ˜¯é‡è¦çš„ä¸Šä¸‹æ–‡çº¿ç´¢ï¼Œå¯ç”¨äºå¸®åŠ©ç†è§£åç»­èŠå¤©å‘ç”Ÿçš„æ—¶é—´ã€‚

                - `type: 'group_name'`ï¼šè¡¨ç¤ºå½“å‰èŠå¤©è®°å½•æ‰€å±çš„å¾®ä¿¡ç¾¤åç§°ï¼Œæ˜¯åˆ¤æ–­èŠå¤©åœºæ™¯çš„é‡è¦ä¾æ®ã€‚

                ä½ éœ€è¦ç»¼åˆä»¥ä¸Šä¸‰ç§ç±»å‹çš„è®°å½•ï¼Œå‡†ç¡®ç†è§£èŠå¤©è¯­å¢ƒã€‚

                ## è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆç»“æ„åŒ–ï¼‰ï¼š
                æ¯æ¡å¼•ç”¨å†…å®¹å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
                - è¯´è¯äººï¼ˆ"æˆ‘"æˆ–ä»–äººæ˜µç§°ï¼‰
                - å†…å®¹
                - æ—¶é—´ï¼ˆå¦‚è®°å½•ä¸­æ— å¯¹åº”æ—¶é—´èŠ‚ç‚¹ï¼Œåˆ™æ ‡è®°ä¸º"æœªçŸ¥"ï¼‰
                - ä¸Šä¸‹æ–‡æŒ‡å‘åˆ†æï¼ˆå¦‚æ¶‰åŠå¼•ç”¨ã€è¯„ä»·ã€åé¦ˆç­‰ï¼Œè¯·è¯´æ˜æŒ‡ä»£è°æˆ–ä»€ä¹ˆå†…å®¹ï¼›å¦‚ä¸æ˜ç¡®åˆ™è¯´æ˜ï¼‰

                ## å›ç­”æ ¼å¼ï¼š

                1. **å¼•ç”¨å†…å®¹ï¼ˆç»“æ„åŒ–åˆ—è¡¨ï¼‰**
                2. **æ€»ç»“æ®µï¼šç®€æ˜æ‰¼è¦è¯´æ˜é—®é¢˜ç­”æ¡ˆçš„æ ¸å¿ƒä¿¡æ¯ï¼ŒåŸºäºå¼•ç”¨å†…å®¹æ’°å†™**

                ## ç¤ºä¾‹å›ç­”ï¼š

                é—®é¢˜ï¼šå¼ ç£Šæåˆ°äº†å“ªäº›SDKé—®é¢˜ï¼Ÿ

                å¼•ç”¨å†…å®¹ï¼š
                - è¯´è¯äººï¼šå¼ ç£Š  
                - å†…å®¹ï¼šstopè¾“å…¥æ—¶è°ƒç”¨äº†stopæ¥å£ï¼Œæ­¤æ—¶æ¸…ç©ºç¼“å†²åŒº  
                - æ—¶é—´ï¼šæœªçŸ¥  
                - ä¸Šä¸‹æ–‡æŒ‡å‘åˆ†æï¼šè¿™æ¡æ¶ˆæ¯è¯´æ˜å¼ ç£Šåœ¨è®¨è®º SDK ä¸­ stop è¾“å…¥åçš„ç¼“å­˜å¤„ç†æœºåˆ¶ã€‚

                æ€»ç»“ï¼šå¼ ç£ŠæŒ‡å‡ºåœ¨ SDK ä¸­ï¼Œè°ƒç”¨ stop æ¥å£æ—¶ä¼šæ¸…ç©ºç¼“å†²åŒºï¼Œå±äº SDK ç¼“å­˜å¤„ç†ç›¸å…³çš„é—®é¢˜ã€‚

                é—®é¢˜ï¼šè°è¯´äº†"openai"ï¼Ÿ
                å›ç­”ï¼šæœªåœ¨èŠå¤©è®°å½•ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚

                ## èŠå¤©è®°å½•ï¼ˆæŒ‰é¡ºåºæ’åˆ—ï¼‰ï¼š
                {result_to_llms}

                è¯·ä½ æ ¹æ®ä¸Šè¿°èŠå¤©è®°å½•ï¼Œå‡†ç¡®å›ç­”ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼Œ#å¹¶å¿…é¡»ç»™å‡ºç»“æ„åŒ–å¼•ç”¨ä¿¡æ¯å’Œæ€»ç»“æ®µã€‚
                """

    
    payload = {
        "model": model_name,
        "prompt": f"ç”¨æˆ·é—®é¢˜ï¼š{user_question}",
        "system": sys_prompt,
        "stream": False
    }
    
    print("æ­£åœ¨å°†è¯†åˆ«ç»“æœå‘é€ç»™æœ¬åœ°Ollamaçš„qwen3:8bæ¨¡å‹...")
    
    try:
        response = requests.post(ollama_url, json=payload)
        response.raise_for_status()
        data = response.json()
        llm_output = data.get("response", "")
        print("Ollamaæ¨¡å‹è¿”å›ç»“æœï¼š")
        print(llm_output)
        return llm_output
    except Exception as e:
        print("è°ƒç”¨Ollamaæ¥å£æ—¶å‡ºé”™ï¼š", e)
        return f"å¤„ç†å¤±è´¥ï¼š{str(e)}"


def main():
    """ä¸»å‡½æ•° - ä¿æŒä¸åŸç‰ˆç›¸åŒçš„è¡Œä¸º"""
    # æ¸…ç†è¾“å‡ºç›®å½•
    if os.path.exists("output_images"):
        shutil.rmtree("output_images")
    if os.path.exists("output_json"):
        shutil.rmtree("output_json")
    
    # åˆå§‹åŒ–å¤„ç†å™¨
    processor = LongImageOCR(config_path="./default_rapidocr.yaml")
    
    # å¤„ç†é•¿å›¾
    image_path = r"/home/kylin/æ¡Œé¢/Long-picture-ocr-LLMs-main_a/images/image copy 18.png"
    
    try:
        result = processor.process_long_image(image_path)
        
        # ç¾åŒ–è¾“å‡ºå¤„ç†ç»“æœæ‘˜è¦
        print("\n" + "="*50)
        print("ğŸ“Š å¤„ç†ç»“æœæ‘˜è¦")
        print("="*50)
        
        # åŸºæœ¬å¤„ç†ç»“æœ
        print(f"ğŸ“ æ€»OCRé¡¹: {result.get('total_ocr_items', 0)}")
        print(f"ğŸ‘¤ æ€»å¤´åƒæ•°: {result.get('total_avatars', 0)}")
        print(f"ğŸ’¬ æ€»æ¶ˆæ¯æ•°: {result.get('total_messages', 0)}")
        print(f"ğŸ—¨ï¸  èŠå¤©æ¶ˆæ¯: {result.get('chat_messages', 0)}")
        print(f"â° æ—¶é—´æ¶ˆæ¯: {result.get('time_messages', 0)}")
        print(f"ğŸ‘¤ æˆ‘çš„æ¶ˆæ¯: {result.get('my_messages', 0)}")
        
        # æ—¶é—´ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        if 'timing' in result:
            timing = result['timing']
            print(f"\nâ±ï¸  æ€»æ‰§è¡Œæ—¶é—´: {timing['total_time']}ç§’")
            
            if 'step3_summary' in timing:
                step3 = timing['step3_summary']
                print(f"ğŸ” åˆ‡ç‰‡å¤„ç†: {step3['total_slices']}ç‰‡, OCRå¹³å‡{step3['average_ocr_time']}ç§’/ç‰‡")
        
        print("="*50)
        
        # è·å–èŠå¤©æ¶ˆæ¯ç”¨äºLLM
        if processor.chat_session:
            chat_messages = processor.chat_session.to_dict()['chat_messages']
            print(f"LLMs_input: {chat_messages}")
            
            # ä¸LLMäº¤äº’
            print("æ­¥éª¤7: å°†ç»“æœè¾“å…¥åˆ°ollamaæ¨¡å‹...")
            while True:
                user_question = input("è¯·è¾“å…¥ä½ æƒ³é—®çš„é—®é¢˜ï¼ˆè¾“å…¥'é€€å‡º'ç»“æŸï¼‰ï¼š")
                if user_question.strip() in ["é€€å‡º", "q", "Q", "exit"]:
                    print("å·²é€€å‡ºä¸ollamaæ¨¡å‹çš„äº¤äº’ã€‚")
                    break
                process_with_llm(user_question, chat_messages)
        
    except Exception as e:
        print(f"å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()